| inputlookup starlink_annual_pools_lookup 
| eval Jan2025AnnualPool = if(pool_name="Jan2025AnnualPool", pool_size, null()) 
| eval Aug2025AnnualPool = if(pool_name="Aug2025AnnualPool", pool_size, null()) 
| stats max(Jan2025AnnualPool) as Jan2025AnnualPool, max(Aug2025AnnualPool) as Aug2025AnnualPool 
| appendcols 
    [| search index=sat_leo_starlink_np "billingCycles.dailyDataUsage.date"="*" earliest=@year 
    | spath output=UsageDate path=billingCycles.dailyDataUsage.date 
    | spath output=EndDate path=billingCycles.endDate 
    | where UsageDate >= "2025-01-01" 
    | stats max(billingCycles.totalPriorityGB) as MaxUsage by serviceLineNumber, EndDate 
    | stats sum(MaxUsage) as TotalPriorityGBytes] 
| eval Jan2025AnnualPool = 1500000,
    Aug2025AnnualPool = 3000000,
    PoolRemaining = Jan2025AnnualPool - TotalPriorityGBytes,
    JanPoolRemaining = if(PoolRemaining < 0, 0, PoolRemaining),
    AugPoolRemaining = if(PoolRemaining > 0, Aug2025AnnualPool, Aug2025AnnualPool + PoolRemaining),
    JanPoolUsed = Jan2025AnnualPool - JanPoolRemaining,
    AugPoolUsed = Aug2025AnnualPool - AugPoolRemaining,
    JanPoolUsedPercent = round((JanPoolUsed / Jan2025AnnualPool) * 100, 2),
    AugPoolUsedPercent = round((AugPoolUsed / Aug2025AnnualPool) * 100, 2) 
| eval jan_data = "January Pool," + Jan2025AnnualPool + "," + JanPoolUsed + "," + JanPoolRemaining + "," + JanPoolUsedPercent,
    aug_data = "August Pool," + Aug2025AnnualPool + "," + AugPoolUsed + "," + AugPoolRemaining + "," + AugPoolUsedPercent 
| eval combined_data = mvappend(jan_data, aug_data) 
| mvexpand combined_data 
| rex field=combined_data "^(?<Period>[^,]+),(?<PoolSize>[^,]+),(?<Used>[^,]+),(?<Remaining>[^,]+),(?<PercentUsed>[^,]+)$" 
| eval "Pool Size (GB)" = tostring(PoolSize, "commas"),
    "Used (GB)" = tostring(round(Used), "commas"),
    "Remaining (GB)" = tostring(round(Remaining), "commas"),
    "Percent Used" = PercentUsed + "%" 
| fields "Period", "Pool Size (GB)", "Used (GB)", "Remaining (GB)", "Percent Used" 
| fields - _mkv_child
