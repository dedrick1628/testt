<form version="1.1" theme="light">
  <label>YL - L3 Division Deep-Dive</label>
  <init>
    <set token="loading">true</set>
    <condition match="isnotnull($form.customer_choice$)">
      <set token="form.customer_choice">$form.customer_choice$</set>
    </condition>
    <condition match="isnotnull($form.division_choice$)">
      <set token="form.division_choice">$form.division_choice$</set>
    </condition>
    <unset token="loading"></unset>
  </init>
  <fieldset>
    <input type="time" token="field1" searchWhenChanged="true">
      <label>Global Time Range</label>
      <default>
        <earliest>@y</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="customer_choice" searchWhenChanged="true">
      <label>Select Customer</label>
      <choice value="*">All</choice>
      <fieldForLabel>customer_name</fieldForLabel>
      <fieldForValue>customer_name</fieldForValue>
      <search>
        <query>| inputlookup satellite_circuit_lookup | dedup customer_name | table customer_name</query>
        <earliest>@y</earliest>
        <latest>now</latest>
      </search>
      <default>*</default>
      <change>
        <condition>
          <eval token="customer_filter">if($value$ == "*", "customer_name=*", "customer_name=\"" . $value$ . "\"")</eval>
        </condition>
        <condition match="isnull($loading$)">
          <set token="form.division_choice">*</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="division_choice" searchWhenChanged="true">
      <label>Select Division</label>
      <choice value="*">All</choice>
      <fieldForLabel>division</fieldForLabel>
      <fieldForValue>division</fieldForValue>
      <search>
        <query>| inputlookup satellite_circuit_lookup | search $customer_filter$ | dedup division | table division</query>
        <earliest>@y</earliest>
        <latest>now</latest>
      </search>
      <default>*</default>
      <change>
        <eval token="division_filter">if($value$ == "*", "division=*", "division=\"" . $value$ . "\"")</eval>
      </change>
    </input>
  </fieldset>
  <row>
    <panel>
      <single>
        <title>Active Terminal Count</title>
        <search>
          <query>
            index=sat_leo_starlink_prod sourcetype="device_terminals"
            | spath path=data{}.userTerminalId output=userterminal
            | spath path=data{}.serviceLineNumber output=servicelinenumber
            | spath path=data{}.active output=terminal_active
            | where servicelinenumber!="null" AND terminal_active="true"
            | dedup userterminal
            | rename servicelinenumber as serviceLineNumber
            | join serviceLineNumber type=left
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true
              | spath output="serviceLineNumber" path=data.serviceLineNumber
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, division
            | search $customer_filter$ $division_filter$
            | stats count
          </query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useThousandSeparators">true</option>
      </single>
    </panel>
    <panel>
      <title>All Circuits by Usage</title>
      <chart>
        <title>More Detailed View</title>
        <search>
          <query>
        index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
        | spath output=totalPriorityGBytes path=billingCycles.totalPriorityGB
        | stats max(totalPriorityGBytes) as priorityGB by serviceLineNumber
        | join type=left serviceLineNumber
          [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true
          | spath output="serviceLineNumber" path=data.serviceLineNumber
          | spath output="nickname" path=data.nickname
          | fields serviceLineNumber nickname]
        | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, division, circuit_alias
        | search $customer_filter$ $division_filter$
        | where isnotnull(nickname) AND isnotnull(circuit_alias)
        | rename circuit_alias as "Circuit Alias", priorityGB as "Usage (GB)", nickname as " "
        | table "Circuit Alias", "Usage (GB)", " "
        | sort - "Usage (GB)"
      </query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.chart">column</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/sat_access/yl__l4_circuit_level?form.customer_choice=$customer_choice%7Cu$&amp;form.division_choice=$division_choice%7Cu$&amp;form.circuit_choice=$row.%20%7Cu$&amp;form.field1.earliest=$field1.earliest%7Cu$&amp;form.field1.latest=$field1.latest%7Cu$&amp;form.input_circuitid=$click.value$</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Division Daily Usage</title>
        <search>
          <query>
            index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
            | spath output=UsageDate path=billingCycles.dailyDataUsage.date
            | eval _time=strptime(UsageDate, "%F")
            | stats max(billingCycles.dailyDataUsage.priorityGB) as priorityGB by serviceLineNumber, _time
            | join type=left serviceLineNumber 
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true 
              | spath output="serviceLineNumber" path=data.serviceLineNumber 
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, division
            | search $customer_filter$ $division_filter$
            | timechart span=1d sum(priorityGB) as "Total Usage (GB)"
          </query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.chart">column</option>
      </chart>
    </panel>
  </row>
</form>
