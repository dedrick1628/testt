| inputlookup starlink_annual_pools_lookup 
| fields pool_name pool_size start_date 
| eval start_ts=strptime(start_date,"%m/%d/%Y") 
| sort 0 start_ts 
| stats values(pool_size) as pool_size values(start_ts) as start_ts by pool_name
| appendcols 
    [| search index=sat_leo_starlink_np "billingCycles.dailyDataUsage.date"="*" earliest=@year 
    | spath output=UsageDate path=billingCycles.dailyDataUsage.date 
    | spath output=EndDate path=billingCycles.endDate 
    | where UsageDate >= strftime(relative_time(now(),"@y"), "%Y-%m-%d") 
    | stats max(billingCycles.totalPriorityGB) as MaxUsage by serviceLineNumber EndDate 
    | stats sum(MaxUsage) as TotalPriorityGBytes
        ] 
| eval TotalPriorityGBytes=coalesce(TotalPriorityGBytes,0)
| streamstats sum(pool_size) as cum_capacity 
| eval prev_capacity=cum_capacity - pool_size 
| eval Used=case(
    TotalPriorityGBytes<=prev_capacity, 0,
    TotalPriorityGBytes>cum_capacity, pool_size,
    true(), TotalPriorityGBytes - prev_capacity
    ) 
| eval Remaining=pool_size - Used 
| eval PercentUsed=round(100*Used/pool_size,2)
| eval "Pool Size (GB)" = tostring(pool_size,"commas"),
    "Used (GB)" = tostring(round(Used),"commas"),
    "Remaining (GB)" = tostring(round(Remaining),"commas"),
    "Percent Used" = PercentUsed . "%" 
| rename pool_name as Period 
| fields Period "Pool Size (GB)" "Used (GB)" "Remaining (GB)" "Percent Used"
