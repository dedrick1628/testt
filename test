<form version="1.1" theme="light">
  <label>YL - L2 Customer Hub Dashboard</label>
  <init>
    <condition match="isnotnull($form.set_customer$)">
      <set token="form.customer_choice">$form.set_customer$</set>
    </condition>
  </init>
  <fieldset>
    <input type="dropdown" token="customer_choice" searchWhenChanged="true">
      <label>Select Customer</label>
      <choice value="*">All</choice>
      <fieldForLabel>customer_name</fieldForLabel>
      <fieldForValue>customer_name</fieldForValue>
      <search>
        <query>| inputlookup satellite_circuit_lookup | dedup customer_name | table customer_name</query>
        <earliest>@y</earliest>
        <latest>now</latest>
      </search>
      <default>*</default>
      <change>
        <eval token="customer_filter">if($value$ == "*", "customer_name=*", "customer_name=\"" . $value$ . "\"")</eval>
        <set token="form.division_choice">*</set>
      </change>
    </input>
    <input type="dropdown" token="division_choice" searchWhenChanged="true">
      <label>Select Division</label>
      <choice value="*">All</choice>
      <fieldForLabel>division</fieldForLabel>
      <fieldForValue>division</fieldForValue>
      <search>
        <query>| inputlookup satellite_circuit_lookup | search $customer_filter$ | dedup division | table division</query>
        <earliest>@y</earliest>
        <latest>now</latest>
      </search>
      <default>*</default>
      <change>
        <eval token="division_filter">if($value$ == "*", "division=*", "division=\"" . $value$ . "\"")</eval>
      </change>
    </input>
  </fieldset>
  <row>
    <panel>
      <chart>
        <title>Customer Usage by Day</title>
        <search>
          <query>
            index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
            | spath output=UsageDate path=billingCycles.dailyDataUsage.date
            | eval _time=strptime(UsageDate, "%F")
            | stats max(billingCycles.dailyDataUsage.priorityGB) as priorityGB by serviceLineNumber, _time
            | join type=left serviceLineNumber 
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true 
              | spath output="serviceLineNumber" path=data.serviceLineNumber 
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, division
            | search $customer_filter$ $division_filter$
            | timechart span=1d sum(priorityGB) as "Total Usage (GB)"
          </query>
          <earliest>@y</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
      </chart>
    </panel>
    <panel>
      <title>Usage by Division</title>
      <chart>
        <title>More Detailed View</title>
        <search>
          <query>
            index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
            | stats max(billingCycles.dailyDataUsage.priorityGB) as priorityGB by serviceLineNumber
            | join type=left serviceLineNumber 
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true 
              | spath output="serviceLineNumber" path=data.serviceLineNumber 
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, division
            | search $customer_filter$
            | stats sum(priorityGB) as "Total Usage (GB)" by division
            | rename division as "Division"
          </query>
          <earliest>@y</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.chart">column</option>
        <drilldown>
          <link target="_blank">/app/sat_access/yl_-_l3_division_usage_deep-dive?form.customer_choice=$customer_choice|u$&amp;form.division_choice=$row.Division|u$&amp;form.field1.earliest=@y&amp;form.field1.latest=now</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Usage Prediction</title>
        <search>
          <query>
            index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
            | spath output=UsageDate path=billingCycles.dailyDataUsage.date
            | eval _time=strptime(UsageDate, "%F")
            | stats max(billingCycles.dailyDataUsage.priorityGB) as priorityGB by serviceLineNumber, _time
            | join type=left serviceLineNumber 
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true 
              | spath output="serviceLineNumber" path=data.serviceLineNumber 
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name
            | search $customer_filter$
            | timechart span=1d sum(priorityGB) as "Actual Usage"
            | predict "Actual Usage" as prediction algorithm=LLP5 holdback=16 future_timespan=60 period=7 
            | eval prediction=if(prediction &lt; 0, 0, prediction)
            | rename prediction as "Predicted Usage"
            | eval "Actual Usage" = round('Actual Usage', 2), "Predicted Usage" = round('Predicted Usage', 2)
            | timechart span=1d first("Actual Usage") as "Actual Usage" first("Predicted Usage") as "Predicted Usage"
          </query>
          <earliest>@y</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>Active Terminal Count</title>
        <search>
          <query>
            index=sat_leo_starlink_prod sourcetype="device_terminals"
            | spath path=data{}.userTerminalId output=userterminal
            | spath path=data{}.serviceLineNumber output=servicelinenumber
            | spath path=data{}.active output=terminal_active
            | where servicelinenumber!="null" AND terminal_active="true"
            | dedup userterminal
            | rename servicelinenumber as serviceLineNumber
            | join serviceLineNumber type=left
              [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true
              | spath output="serviceLineNumber" path=data.serviceLineNumber
              | spath output="nickname" path=data.nickname
              | fields serviceLineNumber nickname]
            | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name
            | search $customer_filter$
            | stats count
          </query>
          <earliest>@y</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useThousandSeparators">true</option>
      </single>
    </panel>
    <panel>
      <chart>
        <title>Top 10 Circuits by Usage</title>
        <search>
          <query>
        index=sat_leo_starlink_prod "billingCycles.dailyDataUsage.date"="*"
        | spath output=totalPriorityGBytes path=billingCycles.totalPriorityGB
        | stats max(totalPriorityGBytes) as priorityGB by serviceLineNumber
        | join type=left serviceLineNumber
          [| search index="sat_leo_starlink_prod" sourcetype=device_servicelines "data.active"=true
          | spath output="serviceLineNumber" path=data.serviceLineNumber
          | spath output="nickname" path=data.nickname
          | fields serviceLineNumber nickname]
        | lookup satellite_circuit_lookup local=true nickname OUTPUT customer_name, circuit_alias
        | search $customer_filter$
        | where isnotnull(nickname) AND isnotnull(circuit_alias)
        | sort 10 - priorityGB
        | rename circuit_alias as "Circuit Alias", priorityGB as "Usage (GB)", nickname as " "
        | table "Circuit Alias", "Usage (GB)", " "
      </query>
          <earliest>@y</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/sat_access/yl_-_l4_the_circuit_usage_forensics_view?form.customer_choice=$customer_choice|u$&amp;form.division_choice=*&amp;form.circuit_choice=$row. |u$&amp;form.field1.earliest=@y&amp;form.field1.latest=now</link>
        </drilldown>
      </chart>
    </panel>
  </row>
</form>
